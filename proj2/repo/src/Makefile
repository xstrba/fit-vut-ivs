## Actual makefile for project is generated by qmake
## This file contains other targets such as test, doc, etc.
## and calls generated Makefile.

TARGET=RebusCalc
PROJDIR=rebuscalc
TSTTARGET=runTests
PROFILETARGET=profile
PACKNAME=xdubec01_xkubik34_xjezik03_xstrba05
PROJVER=0.0.1

.PHONY: profile $(TARGET) doc install uninstall

all: $(TARGET) profile_comp

#### run and compile project ###########################

run:
	test -f $(TARGET) || make $(TARGET)
	./$(TARGET)

$(TARGET): $(PROJDIR)/Makefile
	test -f $(PROJDIR)/debug/RebusCalc && make debug_clear || : #do nothing
		cd $(PROJDIR) && make && cd ..

debug_clear:
	rm -rf $(PROJDIR)/debug/RebusCalc
	cd $(PROJDIR) && qmake "CONFIG += release" RebusCalc.pro && cd ..
	
$(PROJDIR)/Makefile: $(PROJDIR)/RebusCalc.pro
	cd $(PROJDIR) && qmake "CONFIG+=release" RebusCalc.pro && cd ..

doc: Doxyfile
	doxygen $<

########################################################
############ tests #####################################

test: $(TSTTARGET)
	#test -f $(TSTTARGET) || make tests 
	./$(TSTTARGET)

$(TSTTARGET): tests/tests_build/Makefile
	cd tests/tests_build/ && make && cd ../..

tests/tests_build/Makefile: tests/tests_build/tests.pro
	cd tests/tests_build/ && qmake tests.pro && cd ../../

########################################################
########### profiling ##################################

profile: 
	test -f $(PROFILETARGET) || make profile_comp
	./$(PROFILETARGET)

profile_comp:
	g++ --std=c++11 -pipe -Wall -Wextra -g -pg ./profiling.cpp -o $(PROFILETARGET)

#########################################################
###################### pack #############################

pack: ../../$(PACKNAME)
	make doc
	test -d $</doc || mkdir $</doc
	cp -ur doc $<
	mv rebuscalc rebuscalc-$(PROJVER)
	tar -czvf rebuscalc_$(PROJVER).orig.tar.gz --exclude='debian' rebuscalc-$(PROJVER)
	cd rebuscalc-$(PROJVER) && dpkg-buildpackage -uc -us -rfakeroot
	cd ..
	rm -rf RebusCalc
	mv rebuscalc-$(PROJVER) rebuscalc
	cp ../dokumentace.pdf dokumentace.pdf
	mv dokumentace.pdf README.pdf
	zip -r RebusCalc.zip *.deb *.orig.tar.gz README.pdf
	rm -rf rebuscalc*0.0.1* README.pdf
	mkdir $</install
	mv RebusCalc.zip $</install
	make clean
	test -d $</repo || mkdir $</repo 
	cp -ur ../ $</repo
	mv $< ./
	zip -r $(PACKNAME).zip $(PACKNAME)
	rm -rf $(PACKNAME)

../../$(PACKNAME):
	mkdir $@ 
	mkdir $@/repo

#########################################################

install: 
	cd $(PROJDIR) && make install && cd ..

uninstall:
	cd $(PROJDIR) && make uninstall && cd ..
	
clean: 
	rm -rf $(TARGET) $(TSTTARGET) $(PROFILETARGET)
	rm -rf doc *gmon* *.zip rebuscalc/debug/*
	rm -rf *gmon*
	test -f tests/tests_build/Makefile && cd tests/tests_build/ && make clean && make distclean || :
	test -f rebuscalc/Makefile && cd rebuscalc/ && make clean && make distclean && cd .. || :
	find . -name \*.pro.user -type f -delete
	find . -name \*.stash -type f -delete
